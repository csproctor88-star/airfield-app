import jsPDF from 'jspdf'
import autoTable from 'jspdf-autotable'
import type { OpenDiscrepanciesData } from './open-discrepancies-data'

interface Options {
  generatedBy: string
  includeNotes: boolean
}

const STATUS_LABELS: Record<string, string> = {
  submitted_to_afm: 'Submitted to AFM',
  submitted_to_ces: 'Submitted to CES',
  awaiting_action_by_ces: 'Awaiting CES Action',
  work_completed_awaiting_verification: 'Awaiting Verification',
  open: 'Open',
}

export function generateOpenDiscrepanciesPdf(data: OpenDiscrepanciesData, opts: Options) {
  const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'letter' })
  const pageWidth = doc.internal.pageSize.getWidth()
  const pageHeight = doc.internal.pageSize.getHeight()
  const margin = 12
  const contentWidth = pageWidth - margin * 2
  let y = margin
  let pageNum = 1

  function addPageNumber() {
    doc.setFontSize(8)
    doc.setTextColor(150)
    doc.text(`Page ${pageNum}`, pageWidth / 2, pageHeight - 6, { align: 'center' })
  }

  function checkPageBreak(needed: number) {
    if (y + needed > pageHeight - 14) {
      addPageNumber()
      doc.addPage()
      pageNum++
      y = margin
    }
  }

  // ── HEADER ──
  doc.setFontSize(8)
  doc.setTextColor(100)
  doc.text('GLIDEPATH', margin, y)
  y += 5

  doc.setFontSize(14)
  doc.setTextColor(0)
  doc.setFont('helvetica', 'bold')
  doc.text('OPEN DISCREPANCIES REPORT', margin, y)
  y += 6

  doc.setFontSize(10)
  doc.setFont('helvetica', 'normal')
  doc.text('Selfridge ANGB (KMTC)', margin, y)
  y += 5

  doc.setFontSize(9)
  doc.setTextColor(60)
  const now = new Date()
  doc.text(`As of: ${now.toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' })}`, margin, y)
  y += 4
  doc.text(`Generated by: ${opts.generatedBy}`, margin, y)
  y += 4
  doc.text(`Total Open: ${data.summary.total}`, margin, y)
  y += 7

  // ── SUMMARY STATISTICS ──
  doc.setFontSize(10)
  doc.setFont('helvetica', 'bold')
  doc.setTextColor(0)
  doc.text('SUMMARY', margin, y)
  y += 1
  doc.setDrawColor(0)
  doc.setLineWidth(0.4)
  doc.line(margin, y, margin + contentWidth, y)
  y += 5
  doc.setFont('helvetica', 'normal')

  // Severity line
  doc.setFontSize(9)
  const sevOrder = ['critical', 'high', 'medium', 'low']
  const sevParts = sevOrder.map((s) => `${s.charAt(0).toUpperCase() + s.slice(1)}: ${data.summary.bySeverity[s] || 0}`)
  sevParts.push(`> 30 Days: ${data.summary.agingOver30}`)
  doc.text(sevParts.join('   |   '), margin, y)
  y += 5

  // By shop
  const shopEntries = Object.entries(data.summary.byShop).sort((a, b) => b[1] - a[1])
  if (shopEntries.length > 0) {
    const shopText = 'By Shop: ' + shopEntries.map(([s, c]) => `${s} (${c})`).join(', ')
    const lines = doc.splitTextToSize(shopText, contentWidth)
    doc.text(lines, margin, y)
    y += lines.length * 4
  }
  y += 3

  // ── DISCREPANCY TABLE ──
  doc.setFontSize(10)
  doc.setFont('helvetica', 'bold')
  doc.setTextColor(0)
  doc.text('ALL OPEN DISCREPANCIES', margin, y)
  y += 1
  doc.setDrawColor(0)
  doc.setLineWidth(0.4)
  doc.line(margin, y, margin + contentWidth, y)
  y += 4
  doc.setFont('helvetica', 'normal')

  // Sort by days open descending (oldest first)
  const sorted = [...data.discrepancies].sort((a, b) => b.days_open - a.days_open)

  const tableBody = sorted.map((d) => {
    const reporter = d.reporter_rank ? `${d.reporter_rank} ${d.reporter_name}` : d.reporter_name
    const lastUpdate = d.last_update_at
      ? new Date(d.last_update_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
      : '—'
    return [
      d.display_id,
      d.title,
      d.type,
      d.location_text,
      d.assigned_shop || '—',
      d.work_order_number || '—',
      STATUS_LABELS[d.current_status] || d.current_status,
      d.days_open.toString(),
      reporter,
      lastUpdate,
    ]
  })

  autoTable(doc, {
    startY: y,
    margin: { left: margin, right: margin },
    head: [['ID', 'Title', 'Type', 'Location', 'Shop', 'W/O #', 'Status', 'Days', 'Reported By', 'Last Update']],
    body: tableBody,
    styles: { fontSize: 7, cellPadding: 1.5, textColor: [0, 0, 0] },
    headStyles: { fillColor: [30, 41, 59], textColor: [255, 255, 255], fontStyle: 'bold', fontSize: 7 },
    alternateRowStyles: { fillColor: [245, 245, 245] },
    columnStyles: {
      0: { cellWidth: 22 },
      1: { cellWidth: 38 },
      7: { cellWidth: 12, halign: 'center' },
    },
    didParseCell: (hookData) => {
      if (hookData.section !== 'body') return
      const rowIdx = hookData.row.index
      const disc = sorted[rowIdx]
      if (!disc) return

      // Bold + red for >30 days
      if (disc.days_open > 30) {
        if (hookData.column.index === 7) {
          hookData.cell.styles.textColor = [220, 38, 38]
          hookData.cell.styles.fontStyle = 'bold'
        }
      }
      // Bold for critical severity
      if (disc.severity === 'critical') {
        if (hookData.column.index === 0 || hookData.column.index === 1) {
          hookData.cell.styles.fontStyle = 'bold'
          hookData.cell.styles.textColor = [220, 38, 38]
        }
      }
    },
  })
  y = (doc as unknown as { lastAutoTable: { finalY: number } }).lastAutoTable.finalY + 4

  // ── DETAIL SECTION (if includeNotes) ──
  if (opts.includeNotes && Object.keys(data.notesHistory).length > 0) {
    checkPageBreak(14)
    doc.setFontSize(10)
    doc.setFont('helvetica', 'bold')
    doc.setTextColor(0)
    doc.text('DETAILED NOTES HISTORY', margin, y)
    y += 1
    doc.setDrawColor(0)
    doc.setLineWidth(0.4)
    doc.line(margin, y, margin + contentWidth, y)
    y += 5
    doc.setFont('helvetica', 'normal')

    for (const disc of sorted) {
      const notes = data.notesHistory[disc.id]
      if (!notes || notes.length === 0) continue

      checkPageBreak(16)

      // Discrepancy header
      doc.setFontSize(8)
      doc.setFont('helvetica', 'bold')
      doc.setTextColor(0)
      doc.text(`${disc.display_id} — ${disc.title}`, margin, y)
      doc.setFont('helvetica', 'normal')
      y += 4

      doc.setFontSize(7)
      doc.setTextColor(80)
      doc.text(`${disc.type} | ${disc.location_text} | ${disc.photo_count} photo${disc.photo_count !== 1 ? 's' : ''} | NOTAM: ${disc.notam_reference || 'None'}`, margin + 2, y)
      y += 4

      // Description
      if (disc.description) {
        const descLines = doc.splitTextToSize(disc.description, contentWidth - 4)
        doc.setFontSize(7)
        doc.setTextColor(60)
        doc.text(descLines, margin + 2, y)
        y += descLines.length * 3
      }
      y += 1

      // Notes
      for (const note of notes) {
        checkPageBreak(8)
        const name = note.user_rank ? `${note.user_rank} ${note.user_name}` : note.user_name
        const time = new Date(note.created_at).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
        const statusText = note.old_status && note.new_status
          ? ` [${STATUS_LABELS[note.old_status] || note.old_status} → ${STATUS_LABELS[note.new_status] || note.new_status}]`
          : ''

        doc.setFontSize(7)
        doc.setTextColor(100)
        doc.text(`${time} — ${name}${statusText}`, margin + 4, y)
        y += 3

        if (note.notes) {
          const noteLines = doc.splitTextToSize(`"${note.notes}"`, contentWidth - 10)
          doc.setTextColor(40)
          doc.text(noteLines, margin + 6, y)
          y += noteLines.length * 3
        }
        y += 1
      }
      y += 2
    }
  }

  // Footer
  addPageNumber()

  // Save
  const dateStr = now.toISOString().split('T')[0]
  doc.save(`KMTC_Open_Discrepancies_${dateStr}.pdf`)
}
